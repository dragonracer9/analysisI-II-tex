\setcounter{secnumdepth}{2}
\setcounter{tocdepth}{1}

%--------Packages--------
\usepackage{tikz}
\usetikzlibrary{calc, arrows}
\usetikzlibrary{shapes}
\usetikzlibrary{patterns,hobby}
\usetikzlibrary{positioning}
\tikzset{>=latex} % for LaTeX arrow head
\colorlet{myred}{red!85!black}
\colorlet{myblue}{blue!80!black}
\colorlet{mydarkred}{myred!80!black}
\colorlet{mydarkblue}{myblue!60!black}
\tikzstyle{xline}=[myblue,thick]
\def\tick#1#2{\draw[thick] (#1) ++ (#2:0.09) --++ (#2-180:0.18)}
\tikzstyle{myarr}=[myblue!50,-{Latex[length=3,width=2]}]
\def\Nr{100}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{longtable}
\usepackage{makecell}
\usepackage{amsmath,amsfonts,amsthm,amssymb,mathrsfs,bbm,mathtools,nicefrac,witharrows,commath,cancel}
\usepackage{enumitem}
\usepackage{xargs}
\usepackage{xcolor}
\usepackage[noabbrev,capitalize]{cleveref}
\usepackage[italic]{derivative}
\usepackage{xparse}
\usepackage{upgreek}
\usepackage{setspace}
\usepackage[most]{tcolorbox}
\usepackage[parfill]{parskip}
\usepackage{centernot}
\usepackage{needspace}

\usepackage{ifthen}
\newboolean{manuscript}

%--------Graphics/Images--------
\usepackage{graphicx}
\usepackage{float}
\usepackage[centerlast,small,sc]{caption}
\usepackage{subcaption} % causes weird error with \setlength{\captionmargin}{20pt}

\usepackage{pgfplots}
\pgfplotsset{compat=1.6}
\usepgfplotslibrary{fillbetween}
\usetikzlibrary{patterns}
\usepackage[outline]{contour} % glow around text
\contourlength{1.0pt}

%--------Index--------
\usepackage[list-style=longtable]{acro}
\usepackage{imakeidx}
\usepackage{hyperref}
\makeindex[intoc]
\indexsetup{headers={\indexname}{\indexname}}
\acsetup{index/use=true}

\NewDocumentCommand{\idxpage}{m}{\hyperpage{#1}}
\NewDocumentCommand{\idxpagebf}{m}{\textbf{\idxpage{#1}}}
\NewDocumentCommand{\pidx}{mo}{\index{\IfValueTF{#2}{#1|#2}{#1|idxpage}}}
\NewDocumentCommand{\idx}{d<>mo}{\emph{\IfValueTF{#1}{#1}{#2}}\pidx{#2}[#3]}
% \NewDocumentCommand{\midx}{d<>omo}{\margintag[#2]{#3}\idx<#1>{#3}[#4]}
\NewDocumentCommand{\midx}{d<>omo}{\idx<#1>{#3}[#4]}

%--------Theorem Environments--------
\newtheorem{thm}{Theorem}[chapter]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{fct}[thm]{Fact}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}

\numberwithin{equation}{chapter}

\Crefname{thm}{Theorem}{Theorems}

\tcbuselibrary{theorems}

\newtcbtheorem
  [use counter*=thm,crefname={Example}{Examples},Crefname={Example}{Examples}]%
  {ex}
  {Example}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=blue!10,
    coltitle=black,
    colframe=blue!10,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify, % use `flush left` if document is raggedright and not justified
  }% options
  {ex}% prefix

%--------Remarks-------------
\newtcbtheorem
  [use counter*=thm,crefname={Remark}{Remarks},Crefname={Remark}{Remarks}]%
  {rmk}
  {Remark}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=gray!20,
    coltitle=black,
    colframe=gray!20,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify,
  }% options
  {rmk}% prefix

%--------Exercises-------------
\newtcbtheorem
  [use counter*=thm,crefname={Problem}{Problems},Crefname={Problem}{Problems}]%
  {exc}
  {Problem}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=purple!10,
    coltitle=black,
    colframe=purple!10,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify,
  }% options
  {exercise}% prefix

%--------Readings-------------
\newtcolorbox{readings}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=green!30,
    coltitle=black,
    colframe=green!30,
    fonttitle=\bfseries,
    title={Readings},
    parbox=false,
    halign=justify,
}
\newtcolorbox{oreadings}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=green!20,
    coltitle=black,
    colframe=green!20,
    fonttitle=\bfseries,
    title={Optional Readings},
    parbox=false,
    halign=justify,
}

%--------important theorems-------------
\newtcolorbox{thmb}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm, top=0cm,
    toptitle=0cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=gray!10,
    coltitle=black,
    colframe=gray!10,
    fonttitle=\bfseries,
    title={},
    parbox=false,
    halign=justify,
}

%--------Colors-------------
\definecolor{blue}{RGB}{02,106,253}
\definecolor{red}{RGB}{245,51,30}
\definecolor{green}{RGB}{96,189,69}
\definecolor{purple}{RGB}{200,0,240}
\def\b{\textcolor{blue}}
\def\r{\textcolor{red}}
\def\g{\textcolor{green}}
\def\purple{\textcolor{purple}}

%--------Margin Tags-------------
% \usepackage{marginfix}
\let\marginnote\relax
\usepackage{marginnote}
\NewDocumentCommand{\margintag}{O{0\baselineskip}m}{%
  \checkoddpage%
  \ifoddpage%
    {\marginnote{\footnotesize #2}[#1]}%
  \else%
    {\reversemarginpar\marginnote{\footnotesize #2}[#1]}%
    % {\marginnote{\footnotesize #2}[#1]}
  \fi}%
% \NewDocumentCommand{\margintagt}{O{0\baselineskip}m}{\marginpar{\vspace{#1}\footnotesize #2}}
\NewDocumentCommand{\safefootnote}{om}{\footnotemark\margintag[#1]{\textsuperscript{\tiny\arabic{footnote}} \normalfont\justifying #2}}

%--------Margin Boxes-------------
\NewDocumentEnvironment{marginbox}{O{0\baselineskip}m}{\begin{marginfigure}[#1]{\textbf{#2}}\quad}{\end{marginfigure}}

%--------Equation numbers in text-------------
\makeatletter
\NewDocumentCommand{\embeq}{m}{%
  \leavevmode\hfill\refstepcounter{equation}\textup{\tagform@{\theequation}}\label{#1}%
}
\makeatother

%--------Equation numbers in algorithms-------------
\makeatletter
\NewDocumentCommand{\algeq}{m}{%
  \leavevmode\Comment*[r]{\refstepcounter{equation}\textup{\tagform@{\theequation}}\label{#1}}%
}
\makeatother

\usepackage{etoolbox}
\makeatletter
% Remove right hand margin in algorithm
\patchcmd{\@algocf@start}% <cmd>
  {-1.5em}% <search>
  {0pt}% <replace>
  {}{}% <success><failure>
\makeatother

%--------Allow page breaks in align-------------
\allowdisplaybreaks

%--------Enumerations-------------
\setlist[enumerate]{noitemsep, topsep=-6pt, leftmargin=16pt}
\setlist[itemize]{noitemsep, topsep=-6pt}

%--------Figures-------------
\usepackage{import}
\usepackage{xifthen}
\usepackage{pdfpages}
\usepackage{transparent}

\NewDocumentCommand{\incfig}{om}{%
    \IfValueTF{#1}{%
        \def\svgwidth{#1}%
    }{%
        \def\svgwidth{\columnwidth}%
    }%
    \centering\import{./figures/}{#2.pdf_tex}%
}
\newcommand{\incplt}[1]{%
  \begin{center}
    \import{./plots/output/}{#1.pgf}
  \end{center}
}

%--------Styling part-------------
\usepackage{titlesec}
\titleclass{\part}{top} % make part like a chapter
\titleformat{\part}
[display]
{\centering\normalfont}
{\vspace{3pt}\Large\smallcaps{\partname} \thepart}
{0pt}
{\vspace{1pc}\Huge\normalfont\textit}
%
\titlespacing*{\part}{0pt}{0pt}{20pt}
%

%--------Exercises-------------
\NewDocumentEnvironment{exercise}{mm}{\begin{exc}{#1}{#2}}{\par\textit{\hyperref[solution:#2]{$\triangleright$ Solution}}
\end{exc}}


\newtheorem{nexc}{}[chapter]
\crefname{nexc}{Problem}{Problems}
\Crefname{nexc}{Problem}{Problems}

\NewDocumentCommand{\excheading}{}{\needspace{6\baselineskip}\section*{Problems}}

\NewDocumentEnvironment{nexercise}{mm}{%
  % Reserve enough space for exactly two lines (heading + one line).
  \needspace{2\baselineskip}%
  \begin{nexc}%
  \hyperref[solution:#2]{\textbf{#1.}}\label{exercise:#2}%
  % Possibly force them into the same paragraph:
  \par\nobreak
  % or \nolinebreak, if you prefer to keep them in one paragraph.
}{%
  \end{nexc}%
}

\NewDocumentCommand{\exerciseref}{mo}{\margintag{\normalfont\textbf{\Cref{exercise:#1} \IfValueT{#2}{({#2})}{}}}}
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=1pt] (char) {#1};}}
\NewDocumentCommand{\exerciserefmark}{mo}{\hyperref[exercise:#1]{\circled{\normalfont\textbf{?}}}\exerciseref{#1}[#2]}

%--------Solutions-------------
\NewDocumentEnvironment{tips}{m}{\paragraph{\normalfont{\textbf{Tipps zu \cref{exercise:#1}.}}}\label{solution:#1}}{}
